# Better Auth + Google OAuth Setup Guide

This document provides step-by-step instructions for completing the authentication setup for the SuperNotebookLM Chrome Extension.

## Prerequisites

- ✅ Better Auth packages installed (`better-auth@1.3.27` and `@convex-dev/better-auth@0.9.2`)
- ✅ Convex backend deployed with Better Auth component
- ✅ BETTER_AUTH_SECRET and SITE_URL environment variables set in Convex

## Manual Setup Steps Required

### 1. Create Google Cloud OAuth Credentials

**Status**: ⚠️ **USER ACTION REQUIRED**

1. **Navigate to Google Cloud Console**:
   - Go to https://console.cloud.google.com/apis/dashboard
   - Create a new project or select an existing one (e.g., "SuperNotebookLM")

2. **Configure OAuth Consent Screen**:
   - Go to "OAuth consent screen" in the left sidebar
   - Select "External" user type for public use
   - Fill in required information:
     - App name: SuperNotebookLM
     - Support email: Your email
     - Developer contact: Your email
   - Add scopes: `email`, `profile`, `openid`
   - Add test users for development phase (optional)
   - Save and continue

3. **Create OAuth 2.0 Client ID**:
   - Go to "Credentials" → "Create Credentials" → "OAuth 2.0 Client ID"
   - Application type: **Web application**
   - Add authorized redirect URIs (CRITICAL - these point to Convex, NOT the extension):
     ```
     https://cheery-salmon-841.convex.site/api/auth/callback/google
     ```
   - Click "Create"
   - Download or copy the Client ID and Client Secret

4. **Store credentials in Convex** (run these commands):
   ```bash
   cd C:\Users\Admin\Desktop\supernotebooklm\supernotebooklm-extension
   npx convex env set GOOGLE_CLIENT_ID "your-client-id-here"
   npx convex env set GOOGLE_CLIENT_SECRET "your-client-secret-here"
   ```

### 2. Get Extension ID and Update Trusted Origins

**Status**: ⚠️ **USER ACTION REQUIRED**

1. **Load the extension in Chrome**:
   ```bash
   npm run build
   ```
   - Open Chrome and go to `chrome://extensions`
   - Enable "Developer mode" (toggle in top right)
   - Click "Load unpacked"
   - Select the `.output/chrome-mv3` directory

2. **Get the Extension ID**:
   - Find your extension in `chrome://extensions`
   - Copy the extension ID (e.g., `abc123def456...`)

3. **Update trusted origins in convex/auth.ts**:
   - Open `convex/auth.ts`
   - Find the `trustedOrigins` array
   - Replace the placeholder with your actual extension ID:
     ```ts
     trustedOrigins: [
       "chrome-extension://YOUR_ACTUAL_EXTENSION_ID",  // ← UPDATE THIS
     ],
     ```

4. **Redeploy Convex**:
   ```bash
   npx convex deploy
   ```

### 3. Test OAuth Flow

Once steps 1 and 2 are complete:

1. Open the extension sidepanel
2. You should see a "Sign in with Google" button
3. Click the button
4. A popup should open for Google OAuth consent
5. Complete the consent flow
6. You should be redirected back and signed in

## Environment Variables Reference

### Convex Deployment Environment
```bash
# Already set:
BETTER_AUTH_SECRET=<auto-generated>
SITE_URL=https://cheery-salmon-841.convex.site
CONVEX_SITE_URL=https://cheery-salmon-841.convex.site  # Built-in

# USER MUST SET:
GOOGLE_CLIENT_ID=<from-google-cloud-console>
GOOGLE_CLIENT_SECRET=<from-google-cloud-console>
```

### Extension .env
```bash
# Already set:
VITE_CONVEX_URL=https://cheery-salmon-841.convex.cloud
VITE_CONVEX_SITE_URL=https://cheery-salmon-841.convex.site
```

## Troubleshooting

### "CORS error" when signing in
**Solution**: Verify extension ID is added to `trustedOrigins` in `convex/auth.ts` and Convex is redeployed.

### "Popup blocked" error
**Solution**: User needs to allow popups for the extension.

### "Redirect URI mismatch" from Google
**Solution**: Verify Google Cloud Console has exact Convex URL in authorized redirect URIs:
- Format: `https://cheery-salmon-841.convex.site/api/auth/callback/google`

### Session doesn't persist after extension reload
**Solution**: Verify Better Auth session storage is working. Check browser storage permissions.

## Files Created

### Convex Backend
- `convex/convex.config.ts` - Better Auth component registration
- `convex/auth.config.ts` - Auth provider configuration
- `convex/auth.ts` - Better Auth instance with Google provider
- `convex/http.ts` - HTTP route handlers for OAuth callbacks

### Chrome Extension
- `src/lib/auth-client.ts` - Better Auth client
- `src/components/providers/ConvexClientProvider.tsx` - Auth provider wrapper
- `src/components/auth/SignInButton.tsx` - Google sign-in button
- `src/components/auth/UserProfile.tsx` - User profile display with sign-out
- `src/components/auth/AuthErrorBoundary.tsx` - Error handling
- `src/hooks/useAuth.ts` - Auth React hook
- `src/stores/authStore.ts` - Zustand auth UI state
- `.env` - Extension environment variables

### Modified Files
- `package.json` - Added Better Auth dependencies
- `.gitignore` - Added `.env`
- `wxt.config.ts` - Added Convex host permissions
- `entrypoints/sidepanel/App.tsx` - Wrapped with ConvexClientProvider

## Next Steps for Future Website

When creating the complementary Next.js website:

1. Add Next.js proxy handlers in `app/api/auth/[...all]/route.ts`
2. Add website origin to `trustedOrigins` in `convex/auth.ts`
3. Add website redirect URI in Google Cloud Console
4. Use same Convex backend - no additional setup needed!

## Support

For issues, check:
- Convex dashboard: https://dashboard.convex.dev
- Better Auth docs: https://www.better-auth.com/docs
- Google OAuth docs: https://developers.google.com/identity/protocols/oauth2
